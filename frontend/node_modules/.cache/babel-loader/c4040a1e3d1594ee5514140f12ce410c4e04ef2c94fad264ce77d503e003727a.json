{"ast":null,"code":"/**\r\n * Authentication Context – single source of truth for auth state\r\n */import React,{createContext,useContext,useState,useEffect,useCallback}from'react';import{jsx as _jsx}from\"react/jsx-runtime\";const API_URL=process.env.REACT_APP_API_URL||'http://localhost:4000/api/v1';const AuthContext=/*#__PURE__*/createContext(undefined);const TOKEN_KEY='krishi-token';const USER_KEY='krishi-user';const PROFILE_KEY='krishi-profile';export const AuthProvider=_ref=>{let{children}=_ref;const[user,setUser]=useState(null);const[token,setToken]=useState(null);const[profile,setProfileState]=useState(null);const[profileLoading,setProfileLoading]=useState(false);// --- Hydrate from localStorage on mount ---\nuseEffect(()=>{const savedToken=localStorage.getItem(TOKEN_KEY);const savedUser=localStorage.getItem(USER_KEY);const savedProfile=localStorage.getItem(PROFILE_KEY);if(savedToken&&savedUser){try{setToken(savedToken);setUser(JSON.parse(savedUser));}catch(e){/* corrupted – ignore */}}if(savedProfile){try{setProfileState(JSON.parse(savedProfile));}catch(e){/* ignore */}}},[]);// --- Fetch profile from backend when token is available ---\nconst refreshProfile=useCallback(async()=>{const t=token||localStorage.getItem(TOKEN_KEY);if(!t)return;setProfileLoading(true);try{const res=await fetch(\"\".concat(API_URL,\"/profile\"),{headers:{Authorization:\"Bearer \".concat(t)}});if(res.ok){const data=await res.json();const p=data.profile||data;setProfileState(p);localStorage.setItem(PROFILE_KEY,JSON.stringify(p));}}catch(e){// Offline or no profile – fine\n}finally{setProfileLoading(false);}},[token]);// Auto-fetch profile on login\nuseEffect(()=>{if(token&&!profile){refreshProfile();}// eslint-disable-next-line react-hooks/exhaustive-deps\n},[token]);const login=(newToken,newUser)=>{setToken(newToken);setUser(newUser);localStorage.setItem(TOKEN_KEY,newToken);localStorage.setItem(USER_KEY,JSON.stringify(newUser));};const logout=()=>{setToken(null);setUser(null);setProfileState(null);localStorage.removeItem(TOKEN_KEY);localStorage.removeItem(USER_KEY);localStorage.removeItem(PROFILE_KEY);};const setProfile=p=>{setProfileState(p);localStorage.setItem(PROFILE_KEY,JSON.stringify(p));};return/*#__PURE__*/_jsx(AuthContext.Provider,{value:{user,token,profile,isAuthenticated:!!token,hasProfile:!!profile,profileLoading,login,logout,setProfile,refreshProfile},children:children});};export const useAuth=()=>{const context=useContext(AuthContext);if(context===undefined){throw new Error('useAuth must be used within an AuthProvider');}return context;};","map":null,"metadata":{},"sourceType":"module","externalDependencies":[]}