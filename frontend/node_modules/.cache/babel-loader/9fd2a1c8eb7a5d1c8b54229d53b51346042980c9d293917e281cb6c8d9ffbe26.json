{"ast":null,"code":"/**\r\n * Authentication Context – single source of truth for auth state\r\n */import React,{createContext,useContext,useState,useEffect,useCallback}from'react';import{jsx as _jsx}from\"react/jsx-runtime\";const API_URL=process.env.REACT_APP_API_URL||'http://localhost:4001/api/v1';const AuthContext=/*#__PURE__*/createContext(undefined);const TOKEN_KEY='krishi-token';const USER_KEY='krishi-user';const PROFILE_KEY='krishi-profile';export const AuthProvider=_ref=>{let{children}=_ref;const[user,setUser]=useState(null);const[token,setToken]=useState(null);const[profile,setProfileState]=useState(null);const[profileLoading,setProfileLoading]=useState(false);// --- Hydrate from localStorage on mount ---\nuseEffect(()=>{const savedToken=localStorage.getItem(TOKEN_KEY);const savedUser=localStorage.getItem(USER_KEY);const savedProfile=localStorage.getItem(PROFILE_KEY);if(savedToken&&savedUser){try{setToken(savedToken);setUser(JSON.parse(savedUser));}catch(e){/* corrupted – ignore */}}if(savedProfile){try{setProfileState(JSON.parse(savedProfile));}catch(e){/* ignore */}}},[]);// --- Fetch profile from backend when token is available ---\nconst refreshProfile=useCallback(async()=>{const t=token||localStorage.getItem(TOKEN_KEY);if(!t)return;setProfileLoading(true);try{const res=await fetch(\"\".concat(API_URL,\"/profile\"),{headers:{Authorization:\"Bearer \".concat(t)}});if(res.ok){const data=await res.json();const p=data.profile||data;setProfileState(p);localStorage.setItem(PROFILE_KEY,JSON.stringify(p));}}catch(e){// Offline or no profile – fine\n}finally{setProfileLoading(false);}},[token]);// Auto-fetch profile on login\nuseEffect(()=>{if(token&&!profile){refreshProfile();}// eslint-disable-next-line react-hooks/exhaustive-deps\n},[token]);const login=(newToken,newUser)=>{setToken(newToken);setUser(newUser);localStorage.setItem(TOKEN_KEY,newToken);localStorage.setItem(USER_KEY,JSON.stringify(newUser));};const logout=()=>{setToken(null);setUser(null);setProfileState(null);localStorage.removeItem(TOKEN_KEY);localStorage.removeItem(USER_KEY);localStorage.removeItem(PROFILE_KEY);};const setProfile=p=>{setProfileState(p);localStorage.setItem(PROFILE_KEY,JSON.stringify(p));};return/*#__PURE__*/_jsx(AuthContext.Provider,{value:{user,token,profile,isAuthenticated:!!token,hasProfile:!!profile,profileLoading,login,logout,setProfile,refreshProfile},children:children});};export const useAuth=()=>{const context=useContext(AuthContext);if(context===undefined){throw new Error('useAuth must be used within an AuthProvider');}return context;};","map":{"version":3,"names":["React","createContext","useContext","useState","useEffect","useCallback","jsx","_jsx","API_URL","process","env","REACT_APP_API_URL","AuthContext","undefined","TOKEN_KEY","USER_KEY","PROFILE_KEY","AuthProvider","_ref","children","user","setUser","token","setToken","profile","setProfileState","profileLoading","setProfileLoading","savedToken","localStorage","getItem","savedUser","savedProfile","JSON","parse","e","refreshProfile","t","res","fetch","concat","headers","Authorization","ok","data","json","p","setItem","stringify","login","newToken","newUser","logout","removeItem","setProfile","Provider","value","isAuthenticated","hasProfile","useAuth","context","Error"],"sources":["C:/Users/gmore/OneDrive/Desktop/Gaurav/krishi-ai/frontend/src/contexts/AuthContext.tsx"],"sourcesContent":["/**\r\n * Authentication Context – single source of truth for auth state\r\n */\r\n\r\nimport React, { createContext, useContext, useState, useEffect, useCallback, ReactNode } from 'react';\r\n\r\nconst API_URL = process.env.REACT_APP_API_URL || 'http://localhost:4001/api/v1';\r\n\r\ninterface User {\r\n  userId: string;\r\n  mobile: string;\r\n}\r\n\r\ninterface FarmerProfile {\r\n  profile_id: string;\r\n  name: string;\r\n  mobile: string;\r\n  state: string;\r\n  district: string;\r\n  village?: string;\r\n  land_type: string;\r\n  acreage: number;\r\n  main_crops: string[];\r\n  family_count: number;\r\n  annual_income: number;\r\n  farmer_type: string;\r\n}\r\n\r\ninterface AuthContextType {\r\n  user: User | null;\r\n  token: string | null;\r\n  profile: FarmerProfile | null;\r\n  isAuthenticated: boolean;\r\n  hasProfile: boolean;\r\n  profileLoading: boolean;\r\n  login: (token: string, user: User) => void;\r\n  logout: () => void;\r\n  setProfile: (p: FarmerProfile) => void;\r\n  refreshProfile: () => Promise<void>;\r\n}\r\n\r\nconst AuthContext = createContext<AuthContextType | undefined>(undefined);\r\n\r\nconst TOKEN_KEY = 'krishi-token';\r\nconst USER_KEY = 'krishi-user';\r\nconst PROFILE_KEY = 'krishi-profile';\r\n\r\nexport const AuthProvider: React.FC<{ children: ReactNode }> = ({ children }) => {\r\n  const [user, setUser] = useState<User | null>(null);\r\n  const [token, setToken] = useState<string | null>(null);\r\n  const [profile, setProfileState] = useState<FarmerProfile | null>(null);\r\n  const [profileLoading, setProfileLoading] = useState(false);\r\n\r\n  // --- Hydrate from localStorage on mount ---\r\n  useEffect(() => {\r\n    const savedToken = localStorage.getItem(TOKEN_KEY);\r\n    const savedUser = localStorage.getItem(USER_KEY);\r\n    const savedProfile = localStorage.getItem(PROFILE_KEY);\r\n\r\n    if (savedToken && savedUser) {\r\n      try {\r\n        setToken(savedToken);\r\n        setUser(JSON.parse(savedUser));\r\n      } catch (e) { /* corrupted – ignore */ }\r\n    }\r\n    if (savedProfile) {\r\n      try { setProfileState(JSON.parse(savedProfile)); } catch (e) { /* ignore */ }\r\n    }\r\n  }, []);\r\n\r\n  // --- Fetch profile from backend when token is available ---\r\n  const refreshProfile = useCallback(async () => {\r\n    const t = token || localStorage.getItem(TOKEN_KEY);\r\n    if (!t) return;\r\n    setProfileLoading(true);\r\n    try {\r\n      const res = await fetch(`${API_URL}/profile`, {\r\n        headers: { Authorization: `Bearer ${t}` }\r\n      });\r\n      if (res.ok) {\r\n        const data = await res.json();\r\n        const p = data.profile || data;\r\n        setProfileState(p);\r\n        localStorage.setItem(PROFILE_KEY, JSON.stringify(p));\r\n      }\r\n    } catch (e) {\r\n      // Offline or no profile – fine\r\n    } finally {\r\n      setProfileLoading(false);\r\n    }\r\n  }, [token]);\r\n\r\n  // Auto-fetch profile on login\r\n  useEffect(() => {\r\n    if (token && !profile) {\r\n      refreshProfile();\r\n    }\r\n    // eslint-disable-next-line react-hooks/exhaustive-deps\r\n  }, [token]);\r\n\r\n  const login = (newToken: string, newUser: User) => {\r\n    setToken(newToken);\r\n    setUser(newUser);\r\n    localStorage.setItem(TOKEN_KEY, newToken);\r\n    localStorage.setItem(USER_KEY, JSON.stringify(newUser));\r\n  };\r\n\r\n  const logout = () => {\r\n    setToken(null);\r\n    setUser(null);\r\n    setProfileState(null);\r\n    localStorage.removeItem(TOKEN_KEY);\r\n    localStorage.removeItem(USER_KEY);\r\n    localStorage.removeItem(PROFILE_KEY);\r\n  };\r\n\r\n  const setProfile = (p: FarmerProfile) => {\r\n    setProfileState(p);\r\n    localStorage.setItem(PROFILE_KEY, JSON.stringify(p));\r\n  };\r\n\r\n  return (\r\n    <AuthContext.Provider value={{\r\n      user,\r\n      token,\r\n      profile,\r\n      isAuthenticated: !!token,\r\n      hasProfile: !!profile,\r\n      profileLoading,\r\n      login,\r\n      logout,\r\n      setProfile,\r\n      refreshProfile\r\n    }}>\r\n      {children}\r\n    </AuthContext.Provider>\r\n  );\r\n};\r\n\r\nexport const useAuth = () => {\r\n  const context = useContext(AuthContext);\r\n  if (context === undefined) {\r\n    throw new Error('useAuth must be used within an AuthProvider');\r\n  }\r\n  return context;\r\n};\r\n"],"mappings":"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","ignoreList":[]},"metadata":{},"sourceType":"module","externalDependencies":[]}