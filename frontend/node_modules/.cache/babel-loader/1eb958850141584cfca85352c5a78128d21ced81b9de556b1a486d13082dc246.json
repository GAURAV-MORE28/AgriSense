{"ast":null,"code":"var _jsxFileName = \"C:\\\\Users\\\\gmore\\\\OneDrive\\\\Desktop\\\\Gaurav\\\\krishi-ai\\\\frontend\\\\src\\\\contexts\\\\AuthContext.tsx\",\n  _s = $RefreshSig$(),\n  _s2 = $RefreshSig$();\n/**\r\n * Authentication Context – single source of truth for auth state\r\n */\n\nimport React, { createContext, useContext, useState, useEffect, useCallback } from 'react';\nimport { jsxDEV as _jsxDEV } from \"react/jsx-dev-runtime\";\nconst API_URL = process.env.REACT_APP_API_URL || 'http://localhost:4000/api/v1';\nconst AuthContext = /*#__PURE__*/createContext(undefined);\nconst TOKEN_KEY = 'krishi-token';\nconst USER_KEY = 'krishi-user';\nconst PROFILE_KEY = 'krishi-profile';\nexport const AuthProvider = ({\n  children\n}) => {\n  _s();\n  const [user, setUser] = useState(null);\n  const [token, setToken] = useState(null);\n  const [profile, setProfileState] = useState(null);\n  const [profileLoading, setProfileLoading] = useState(false);\n\n  // --- Hydrate from localStorage on mount ---\n  useEffect(() => {\n    const savedToken = localStorage.getItem(TOKEN_KEY);\n    const savedUser = localStorage.getItem(USER_KEY);\n    const savedProfile = localStorage.getItem(PROFILE_KEY);\n    if (savedToken && savedUser) {\n      try {\n        setToken(savedToken);\n        setUser(JSON.parse(savedUser));\n      } catch (e) {/* corrupted – ignore */}\n    }\n    if (savedProfile) {\n      try {\n        setProfileState(JSON.parse(savedProfile));\n      } catch (e) {/* ignore */}\n    }\n  }, []);\n\n  // --- Fetch profile from backend when token is available ---\n  const refreshProfile = useCallback(async () => {\n    const t = token || localStorage.getItem(TOKEN_KEY);\n    if (!t) return;\n    setProfileLoading(true);\n    try {\n      const res = await fetch(`${API_URL}/profile`, {\n        headers: {\n          Authorization: `Bearer ${t}`\n        }\n      });\n      if (res.ok) {\n        const data = await res.json();\n        const p = data.profile || data;\n        setProfileState(p);\n        localStorage.setItem(PROFILE_KEY, JSON.stringify(p));\n      } else if (res.status === 404) {\n        // No profile yet – clear stale cache\n        setProfileState(null);\n        localStorage.removeItem(PROFILE_KEY);\n      }\n    } catch (e) {\n      // Offline or network error – keep localStorage cache\n    } finally {\n      setProfileLoading(false);\n    }\n  }, [token]);\n\n  // Always re-fetch profile from backend when token is available\n  // This ensures profile persists even after page reload / DB changes\n  useEffect(() => {\n    if (token) {\n      refreshProfile();\n    }\n    // eslint-disable-next-line react-hooks/exhaustive-deps\n  }, [token]);\n  const login = (newToken, newUser) => {\n    setToken(newToken);\n    setUser(newUser);\n    localStorage.setItem(TOKEN_KEY, newToken);\n    localStorage.setItem(USER_KEY, JSON.stringify(newUser));\n  };\n  const logout = () => {\n    setToken(null);\n    setUser(null);\n    setProfileState(null);\n    localStorage.removeItem(TOKEN_KEY);\n    localStorage.removeItem(USER_KEY);\n    localStorage.removeItem(PROFILE_KEY);\n  };\n  const setProfile = p => {\n    setProfileState(p);\n    localStorage.setItem(PROFILE_KEY, JSON.stringify(p));\n  };\n  return /*#__PURE__*/_jsxDEV(AuthContext.Provider, {\n    value: {\n      user,\n      token,\n      profile,\n      isAuthenticated: !!token,\n      hasProfile: !!profile,\n      isAdmin: (user === null || user === void 0 ? void 0 : user.role) === 'admin',\n      profileLoading,\n      login,\n      logout,\n      setProfile,\n      refreshProfile\n    },\n    children: children\n  }, void 0, false, {\n    fileName: _jsxFileName,\n    lineNumber: 141,\n    columnNumber: 5\n  }, this);\n};\n_s(AuthProvider, \"ZkSU2jt+4po4jmy6QOSKls2E6yo=\");\n_c = AuthProvider;\nexport const useAuth = () => {\n  _s2();\n  const context = useContext(AuthContext);\n  if (context === undefined) {\n    throw new Error('useAuth must be used within an AuthProvider');\n  }\n  return context;\n};\n_s2(useAuth, \"b9L3QQ+jgeyIrH0NfHrJ8nn7VMU=\");\nvar _c;\n$RefreshReg$(_c, \"AuthProvider\");","map":{"version":3,"names":["React","createContext","useContext","useState","useEffect","useCallback","jsxDEV","_jsxDEV","API_URL","process","env","REACT_APP_API_URL","AuthContext","undefined","TOKEN_KEY","USER_KEY","PROFILE_KEY","AuthProvider","children","_s","user","setUser","token","setToken","profile","setProfileState","profileLoading","setProfileLoading","savedToken","localStorage","getItem","savedUser","savedProfile","JSON","parse","e","refreshProfile","t","res","fetch","headers","Authorization","ok","data","json","p","setItem","stringify","status","removeItem","login","newToken","newUser","logout","setProfile","Provider","value","isAuthenticated","hasProfile","isAdmin","role","fileName","_jsxFileName","lineNumber","columnNumber","_c","useAuth","_s2","context","Error","$RefreshReg$"],"sources":["C:/Users/gmore/OneDrive/Desktop/Gaurav/krishi-ai/frontend/src/contexts/AuthContext.tsx"],"sourcesContent":["/**\r\n * Authentication Context – single source of truth for auth state\r\n */\r\n\r\nimport React, { createContext, useContext, useState, useEffect, useCallback, ReactNode } from 'react';\r\n\r\nconst API_URL = process.env.REACT_APP_API_URL || 'http://localhost:4000/api/v1';\r\n\r\ninterface User {\r\n  userId: string;\r\n  mobile: string;\r\n  role: string;\r\n}\r\n\r\ninterface FarmerProfile {\r\n  profile_id: string;\r\n  name: string;\r\n  mobile: string;\r\n  state: string;\r\n  district: string;\r\n  village?: string;\r\n  land_type: string;\r\n  acreage: number;\r\n  main_crops: string[];\r\n  family_count: number;\r\n  annual_income: number;\r\n  farmer_type: string;\r\n  // Extended fields\r\n  education_level?: string;\r\n  irrigation_available?: boolean;\r\n  loan_status?: string;\r\n  bank_account_linked?: boolean;\r\n  aadhaar_linked?: boolean;\r\n  caste_category?: string;\r\n  livestock?: string[];\r\n  soil_type?: string;\r\n  water_source?: string;\r\n  machinery_owned?: string[];\r\n}\r\n\r\ninterface AuthContextType {\r\n  user: User | null;\r\n  token: string | null;\r\n  profile: FarmerProfile | null;\r\n  isAuthenticated: boolean;\r\n  hasProfile: boolean;\r\n  isAdmin: boolean;\r\n  profileLoading: boolean;\r\n  login: (token: string, user: User) => void;\r\n  logout: () => void;\r\n  setProfile: (p: FarmerProfile) => void;\r\n  refreshProfile: () => Promise<void>;\r\n}\r\n\r\nconst AuthContext = createContext<AuthContextType | undefined>(undefined);\r\n\r\nconst TOKEN_KEY = 'krishi-token';\r\nconst USER_KEY = 'krishi-user';\r\nconst PROFILE_KEY = 'krishi-profile';\r\n\r\nexport const AuthProvider: React.FC<{ children: ReactNode }> = ({ children }) => {\r\n  const [user, setUser] = useState<User | null>(null);\r\n  const [token, setToken] = useState<string | null>(null);\r\n  const [profile, setProfileState] = useState<FarmerProfile | null>(null);\r\n  const [profileLoading, setProfileLoading] = useState(false);\r\n\r\n  // --- Hydrate from localStorage on mount ---\r\n  useEffect(() => {\r\n    const savedToken = localStorage.getItem(TOKEN_KEY);\r\n    const savedUser = localStorage.getItem(USER_KEY);\r\n    const savedProfile = localStorage.getItem(PROFILE_KEY);\r\n\r\n    if (savedToken && savedUser) {\r\n      try {\r\n        setToken(savedToken);\r\n        setUser(JSON.parse(savedUser));\r\n      } catch (e) { /* corrupted – ignore */ }\r\n    }\r\n    if (savedProfile) {\r\n      try { setProfileState(JSON.parse(savedProfile)); } catch (e) { /* ignore */ }\r\n    }\r\n  }, []);\r\n\r\n  // --- Fetch profile from backend when token is available ---\r\n  const refreshProfile = useCallback(async () => {\r\n    const t = token || localStorage.getItem(TOKEN_KEY);\r\n    if (!t) return;\r\n    setProfileLoading(true);\r\n    try {\r\n      const res = await fetch(`${API_URL}/profile`, {\r\n        headers: { Authorization: `Bearer ${t}` }\r\n      });\r\n      if (res.ok) {\r\n        const data = await res.json();\r\n        const p = data.profile || data;\r\n        setProfileState(p);\r\n        localStorage.setItem(PROFILE_KEY, JSON.stringify(p));\r\n      } else if (res.status === 404) {\r\n        // No profile yet – clear stale cache\r\n        setProfileState(null);\r\n        localStorage.removeItem(PROFILE_KEY);\r\n      }\r\n    } catch (e) {\r\n      // Offline or network error – keep localStorage cache\r\n    } finally {\r\n      setProfileLoading(false);\r\n    }\r\n  }, [token]);\r\n\r\n  // Always re-fetch profile from backend when token is available\r\n  // This ensures profile persists even after page reload / DB changes\r\n  useEffect(() => {\r\n    if (token) {\r\n      refreshProfile();\r\n    }\r\n    // eslint-disable-next-line react-hooks/exhaustive-deps\r\n  }, [token]);\r\n\r\n  const login = (newToken: string, newUser: User) => {\r\n    setToken(newToken);\r\n    setUser(newUser);\r\n    localStorage.setItem(TOKEN_KEY, newToken);\r\n    localStorage.setItem(USER_KEY, JSON.stringify(newUser));\r\n  };\r\n\r\n  const logout = () => {\r\n    setToken(null);\r\n    setUser(null);\r\n    setProfileState(null);\r\n    localStorage.removeItem(TOKEN_KEY);\r\n    localStorage.removeItem(USER_KEY);\r\n    localStorage.removeItem(PROFILE_KEY);\r\n  };\r\n\r\n  const setProfile = (p: FarmerProfile) => {\r\n    setProfileState(p);\r\n    localStorage.setItem(PROFILE_KEY, JSON.stringify(p));\r\n  };\r\n\r\n  return (\r\n    <AuthContext.Provider value={{\r\n      user,\r\n      token,\r\n      profile,\r\n      isAuthenticated: !!token,\r\n      hasProfile: !!profile,\r\n      isAdmin: user?.role === 'admin',\r\n      profileLoading,\r\n      login,\r\n      logout,\r\n      setProfile,\r\n      refreshProfile\r\n    }}>\r\n      {children}\r\n    </AuthContext.Provider>\r\n  );\r\n};\r\n\r\nexport const useAuth = () => {\r\n  const context = useContext(AuthContext);\r\n  if (context === undefined) {\r\n    throw new Error('useAuth must be used within an AuthProvider');\r\n  }\r\n  return context;\r\n};\r\n"],"mappings":"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","ignoreList":[]},"metadata":{},"sourceType":"module","externalDependencies":[]}